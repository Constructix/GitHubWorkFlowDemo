# This workflow will build a .NET Core project and deploy it to an Azure Functions App on Windows or Linux when a commit is pushed to your default branch.
#
# This workflow assumes you have already created the target Azure Functions app.
# For instructions see https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-csharp?tabs=in-process
#
# To configure this workflow:
# 1. Set up the following secrets in your repository:
#   - AZURE_FUNCTIONAPP_PUBLISH_PROFILE
# 2. Change env variables for your configuration.
#
# For more information on:
#   - GitHub Actions for Azure: https://github.com/Azure/Actions
#   - Azure Functions Action: https://github.com/Azure/functions-action
#   - Publish Profile: https://github.com/Azure/functions-action#using-publish-profile-as-deployment-credential-recommended
#   - Azure Service Principal for RBAC: https://github.com/Azure/functions-action#using-azure-service-principal-for-rbac-as-deployment-credential
#
# For more samples to get started with GitHub Action workflows to deploy to Azure: https://github.com/Azure/actions-workflow-samples/tree/master/FunctionApp

name: Deploy DotNet project to Azure Function App

on:
  push:
    branches: ["main"]
env:

  AZURE_FUNCTIONAPP_NAME: 'fa-constructix-onlineservices-getsuppliers'   # set this to your function app name on Azure
  AZURE_FUNCTIONAPP_PACKAGE_PATH: '.\src\Constructix.OnLineServices.Functions.GetSuppliers\'       # set this to the path to your function app project, defaults to the repository root
  AZURE_FUNCTIONAPP_TEST_PATH: '.\tests\Constructix.OnLineServices.Functions.GetSuppliers.Tests\Constructix.OnLineServices.Functions.GetSuppliers.Tests.csproj'
  DOTNET_VERSION: '10.0.x'                   # set this to the dotnet version to use (e.g. '2.1.x', '3.1.x', '5.0.x')
  AZURE_RESOURCE_GROUP: 'rg-constructix-dev-ae-01'
  AZURE_STORAGE_ACCOUNT : 'sadevaeconstructixs01'
  AZURE_STORAGE_CONTAINER: 'app-package-testdev'
  PACKAGE_NAME: 'function-package.zip'
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest #windows-latest # For Linux, use ubuntu-latest
    environment: dev
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    # If you want to use Azure RBAC instead of Publish Profile, then uncomment the task below
    # - name: 'Login via Azure CLI'
    #   uses: azure/login@v1
    #   with:
    #     creds: ${{ secrets.AZURE_RBAC_CREDENTIALS }} # set up AZURE_RBAC_CREDENTIALS secrets in your repository

    - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Resolve Project Dependencies Using Dotnet'
      shell: pwsh # For Linux, use bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        dotnet build --configuration Release --output ./output
        popd
    - name: 'Run Unit tests'
      run: dotnet test  './${{ env.AZURE_FUNCTIONAPP_TEST_PATH }}'
    - name: 'Debug - List files'
      run: |
        echo "Current directory: $(pwd)"
        echo "Listing Deployment folder:"
        ls -la ./Deployment/
        echo "Listing Deployment/ArmTemplates folder (if exists):"
        ls -la ./Deployment/ArmTemplates/ || echo "ArmTemplates folder not found"
        echo "Listing Deployment/ArmTemplates folder (if exists):"
        ls -la ./Deployment/ArmTemplates/ || echo "ArmTemplates folder not found"
    - name: Log into Azure
      uses: azure/login@v1
      with: 
        creds:  ${{ secrets.AZURE_CREDENTIALS }}    
    # - name: Deploy Bicep File
    #   uses: azure/arm-deploy@v1
    #   with:
    #     subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
    #     resourceGroupName: ${{ secrets.AZURE_RG }}
    #     template: ./main.bicep
    #     parameters: 'storagePrefix=rjmystore storageSKU=Standard_LRS'
    #     failOnStdErr: false
    - name: Deploy Provision Resources Bicep File
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
        resourceGroupName: ${{ secrets.AZURE_RG }}
        template: ./Deployment/ArmTemplates/CreateFunction.bicep
        parameters: ./Deployment/ArmTemplates/function-dev-parameters.json
        failOnStdErr: false
    - name: 'Prepare deployment package'
      run: |
        cd ./src/Constructix.OnLineServices.Functions.GetSuppliers
        dotnet publish -c Release -o ./output
        cd output
        # Flex Consumption requires the zip to contain the function artifacts at root level
        zip -r ${{ github.workspace }}/${{ env.PACKAGE_NAME }} *
        #verify the zip file
        echo "Listing contents of the zip file:"
        echo "✅ Deployment package created at: ${{ github.workspace }}/${{ env.PACKAGE_NAME }}"
        ls -la ${{ github.workspace }}/${{ env.PACKAGE_NAME }}

    - name: 'Debug - List files'
      run: |
        echo "Current directory: $(pwd)"
        echo "Listing Deployment folder:"
        ls -la ./       
    
    - name: 'Upload package to Azure Blob Storage'
      run: |
        # Get storage account connection string
        CONNECTION_STRING=$(az storage account show-connection-string \
          --name ${{ env.AZURE_STORAGE_ACCOUNT }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query connectionString -o tsv)
        
        # Generate SAS token with 24 hour expiry
        END_DATE=$(date -u -d "24 hours" '+%Y-%m-%dT%H:%MZ')
        SAS_TOKEN=$(az storage container generate-sas \
          --account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
          --name ${{ env.AZURE_STORAGE_CONTAINER }} \
          --permissions acdlrw \
          --expiry $END_DATE \
          --connection-string "$CONNECTION_STRING" \
          -o tsv)
        
        # Upload package to blob storage
        az storage blob upload \
          --account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
          --container-name ${{ env.AZURE_STORAGE_CONTAINER }} \
          --file ${{ github.workspace }}/${{ env.PACKAGE_NAME }} \
          --name ${{ env.PACKAGE_NAME }} \
          --connection-string "$CONNECTION_STRING" \
          --overwrite
        
        # Generate URL with SAS token
        BLOB_URL="https://${{ env.AZURE_STORAGE_ACCOUNT }}.blob.core.windows.net/${{ env.AZURE_STORAGE_CONTAINER }}/${{ env.PACKAGE_NAME }}?$SAS_TOKEN"
        
        # Save URL for next step
        echo "BLOB_URL=$BLOB_URL" >> $GITHUB_ENV
        
        echo "✅ Package uploaded to: $BLOB_URL"    
    - name: 'Update Function App with Package Reference'
      run: |
        # Update the function app configuration to use the new package
        az functionapp config set \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --linux-fx-version "DOTNET-ISOLATED|10.0" \
          --slot-settings "WEBSITE_RUN_FROM_PACKAGE=${{ env.BLOB_URL }}"
        
        # Alternative: Update the deployment package directly
        az functionapp deployment source config-zip \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --src ${{ github.workspace }}/${{ env.PACKAGE_NAME }} \
          --build-remote false
        
        echo "✅ Function app updated with new package"

    - name: 'Update application settings'
      run: |
        # Update the function app configuration to use the new package
        az functionapp config set \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --linux-fx-version "DOTNET-ISOLATED|10.0" \
          --slot-settings "WEBSITE_RUN_FROM_PACKAGE=${{ env.BLOB_URL }}"
        
        # Alternative: Update the deployment package directly
        az functionapp deployment source config-zip \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --src ${{ github.workspace }}/${{ env.PACKAGE_NAME }} \
          --build-remote false
        
        echo "✅ Function app updated with new package"
    - name: 'Restart Function App'
      run: |
        az functionapp restart \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        
        echo "✅ Function app restarted"
    # deploy function
    # - name: 'Run Azure Functions Action'
    #   uses: Azure/functions-action@v1
    #   id: fa
    #   with:
    #     app-name: 'fa-constructix-onlineservices-getsuppliers'
    #     slot-name: 'production'
    #     package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/output'



    #- name: 'Run Azure Functions Action'
    #  uses: Azure/functions-action@v1
    #  id: fa
    #  with:
    #    app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
    #    package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/output'
    #    publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }} # Remove publish-profile to use Azure RBAC
